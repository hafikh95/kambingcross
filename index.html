<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Saudagar Road Rush</title>
<style>
:root{
  --bg:#0a1220;--text:#e5e7eb;--muted:#94a3b8;
  --road:#0f1420;--edge:#0a1a12;--hud:#111827;--accent:#22c55e;--danger:#ef4444;
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:
  radial-gradient(1200px 600px at 20% -10%,#1e293b,transparent),
  radial-gradient(900px 500px at 120% 10%,#0b1220,transparent),var(--bg);
  color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden}
main{display:grid;place-items:center;height:100dvh;padding:10px}
canvas{max-width:100%;height:auto;border-radius:18px;box-shadow:0 14px 36px rgba(0,0,0,.35)}
.hud{position:fixed;inset:0 0 auto 0;height:56px;display:flex;align-items:center;gap:10px;
  padding:8px 12px;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,0));z-index:10}
.badge{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:12px}
.hud .meter{height:10px;width:140px;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.14);background:#0b1220}
.meter>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#84cc16)}
.hud .hearts{display:flex;gap:6px;margin-left:6px}
.score{margin-left:auto;font-weight:800}
.btns{position:fixed;inset:auto 0 14px 0;display:flex;justify-content:center;gap:12px;z-index:9}
.ctrl{padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.15);
  background:linear-gradient(180deg,#1f2937,#0f172a);color:#fff;font-weight:900;min-width:90px}
.overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:20}
.card{width:min(560px,calc(100vw - 32px));border-radius:16px;padding:16px;backdrop-filter:blur(8px);
  border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));text-align:center}
.card h1{margin:6px 0 4px;font-size:22px}
.card p{margin:8px 0;color:var(--muted)}
.row{display:flex;gap:8px;justify-content:center;margin-top:10px}
.cta{padding:12px 16px;border-radius:12px;font-weight:800;border:1px solid rgba(255,255,255,.18);cursor:pointer}
.primary{background:linear-gradient(180deg,#22c55e,#16a34a);color:#fff}
.ghost{background:rgba(255,255,255,.08);color:#e5e7eb}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:30;
  padding:8px 12px;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.14);color:#d1fae5;border-radius:10px;font-size:13px;display:none}
@media (min-width:720px){.btns{gap:18px}.ctrl{min-width:120px}}
</style>
</head>
<body>
<div class="hud">
  <span class="badge">üöó Road Rush</span>
  <div class="meter" title="Fuel"><span id="fuelBar" style="width:100%"></span></div>
  <div class="hearts" id="hearts"></div>
  <div class="score" id="score">0</div>
</div>

<main>
  <canvas id="game" width="480" height="860" aria-label="Saudagar Road Rush"></canvas>
</main>

<div class="btns">
  <button class="ctrl" id="leftBtn">‚óÄ</button>
  <button class="ctrl" id="brakeBtn">‚õî Brek</button>
  <button class="ctrl" id="rightBtn">‚ñ∂</button>
</div>

<div class="overlay" id="overlay">
  <div class="card">
    <h1>Saudagar Road Rush</h1>
    <p>Elak trafik, kumpul kanister minyak & kekalkan kombo near-miss untuk skor tinggi.<br/>‚Üê/‚Üí atau butang: tukar lorong ¬∑ Tahan **Brek** untuk perlahan ¬∑ Auto-gerak ke depan.</p>
    <p><b>Tip:</b> Potong rapat kereta lain untuk naikkan multiplier. Hati ‚ù§Ô∏è dan minyak ‚õΩ muncul sekali-sekala.</p>
    <div class="row">
      <button class="cta ghost" id="howBtn">Cara Main</button>
      <button class="cta primary" id="startBtn">Mula</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
;(()=>{
  // ================= CONFIG =================
  const LANES = 3;
  const LIVES_MAX = 3;
  const WORLD_BASE = 180;        // kelajuan latar/arus asas (px/s)
  const PLAYER_MAX = 360;        // kelajuan maksimum pemain
  const ACCEL = 280;             // pecut (px/s^2)
  const BRAKE = 420;             // brek (px/s^2)
  const LANE_CHANGE_SPEED = 8.0; // kelajuan interpolasi tukar lorong
  const FUEL_MAX = 100;
  const FUEL_DRAIN = 4.2;        // per saat
  const NEAR_MISS_DIST = 34;     // < jarak ini = near-miss
  const NEAR_MISS_TIME = 900;    // ms multiplier decay
  const DAYNIGHT_SPEED = 0.03;   // kitaran siang malam
  // ==========================================

  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const howBtn = document.getElementById('howBtn');
  const overlay = document.getElementById('overlay');
  const toast = document.getElementById('toast');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const brakeBtn = document.getElementById('brakeBtn');
  const heartsEl = document.getElementById('hearts');
  const fuelBar = document.getElementById('fuelBar');
  const scoreEl = document.getElementById('score');

  // Responsive
  function fitCanvas(){
    const pad=10, w=Math.min(520, innerWidth-pad*2), h=Math.min(980, innerHeight-pad*2);
    const targetH=Math.max(h, w*1.65); cvs.width=w; cvs.height=targetH;
  }
  fitCanvas(); addEventListener('resize', fitCanvas);

  // World state
  const state = {
    running:false, gameOver:false,
    lives:LIVES_MAX, fuel:FUEL_MAX,
    score:0, best: Number(localStorage.getItem('rr_best')||0),
    t:0, // time
    player:{
      lane:1, target:1, x:0, y:0, w:0, h:0, speed:200
    },
    traffic:[], pickups:[], // vehicles & items
    spawn: {timer:0, gap:1.2}, // traffic interval
    night: 0, // 0..1
    multiplier:1, nearMissTimer:0
  };

  function laneX(idx){
    const roadW = cvs.width*0.82, roadL = LANES;
    const left = (cvs.width-roadW)/2;
    return left + (idx+0.5)*(roadW/roadL);
  }
  function laneWidth(){ return (cvs.width*0.82)/LANES; }

  function reset(){
    state.running=false; state.gameOver=false;
    state.lives=LIVES_MAX; state.fuel=FUEL_MAX; state.score=0;
    state.player.lane=1; state.player.target=1;
    const h = laneWidth()*1.2;
    state.player.w = Math.floor(laneWidth()*0.55);
    state.player.h = Math.floor(h*0.8);
    state.player.x = laneX(state.player.lane)-state.player.w/2;
    state.player.y = cvs.height - (laneWidth()*0.9);
    state.player.speed = 200;
    state.traffic.length=0; state.pickups.length=0;
    state.spawn.timer=0; state.spawn.gap=1.2;
    state.multiplier=1; state.nearMissTimer=0; state.night=0;
    updateHearts(); updateFuel(); scoreEl.textContent = "0";
    showOverlay(true);
  }

  function showOverlay(show){ overlay.style.display = show ? "grid" : "none"; }
  function toastMsg(msg,ms=1200){ toast.textContent=msg; toast.style.display="block"; setTimeout(()=>toast.style.display="none",ms); }
  function updateHearts(){
    heartsEl.innerHTML=""; for(let i=0;i<LIVES_MAX;i++){ const s=document.createElement('span'); s.textContent=i<state.lives?"‚ù§Ô∏è":"üñ§"; heartsEl.appendChild(s);}
  }
  function updateFuel(){ fuelBar.style.width = Math.max(0,Math.min(1,state.fuel/FUEL_MAX))*100 + "%"; }

  // Controls
  function changeLane(dir){
    if(!state.running) return;
    const t = state.player.target + dir;
    state.player.target = Math.max(0, Math.min(LANES-1, t));
  }
  let braking = false;
  leftBtn.onclick = ()=>changeLane(-1);
  rightBtn.onclick = ()=>changeLane(1);
  brakeBtn.onpointerdown = ()=> braking=true;
  brakeBtn.onpointerup = brakeBtn.onpointercancel = ()=> braking=false;

  addEventListener('keydown', e=>{
    if(e.code==="ArrowLeft") changeLane(-1);
    if(e.code==="ArrowRight") changeLane(1);
    if(e.code==="Space"||e.code==="ArrowDown") braking=true;
    if(e.code==="Enter" && !state.running) start();
  });
  addEventListener('keyup', e=>{
    if(e.code==="Space"||e.code==="ArrowDown") braking=false;
  });

  startBtn.onclick = start;
  howBtn.onclick = ()=> toastMsg("‚Üê/‚Üí tukar lorong ¬∑ Tahan brek untuk perlahan. Near-miss naikkan multiplier!");

  function start(){ showOverlay(false); state.running=true; state.t=performance.now(); requestAnimationFrame(loop); toastMsg("Hati-hati di jalan! Near-miss untuk +multiplier"); }

  // Entities
  function spawnVehicle(){
    const lane = Math.floor(Math.random()*LANES);
    // check last vehicle in lane to avoid spawn overlap
    const last = [...state.traffic].reverse().find(v=>v.lane===lane);
    const minGap = laneWidth()*1.6;
    if(last && (last.y < -minGap)) return; // tunggu
    const lw = laneWidth(), isTruck = Math.random()<0.25;
    const w = Math.floor(lw * (isTruck?0.65:0.5));
    const h = Math.floor(lw * (isTruck?1.6:1.2));
    const speed = WORLD_BASE + 60 + Math.random()*140; // bergerak turun
    const color = ["#60a5fa","#22c55e","#f59e0b","#a78bfa","#ef4444","#14b8a6","#f97316","#38bdf8"][Math.floor(Math.random()*8)];
    state.traffic.push({lane,x: laneX(lane)-w/2,y:-h-20,w,h,speed,color,truck:isTruck});
  }
  function spawnPickup(){
    const lane = Math.floor(Math.random()*LANES);
    const kind = Math.random()<0.7? "fuel" : "heart";
    const size = Math.floor(laneWidth()*0.38);
    state.pickups.push({lane,x: laneX(lane)-size/2,y:-size-20,w:size,h:size,kind});
  }

  // Drawing helpers
  function rrect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill(); }
  function drawCar(v){
    // shadow
    ctx.fillStyle="rgba(0,0,0,.28)"; rrect(v.x+2,v.y+4,v.w,v.h*0.9,10);
    // body
    ctx.fillStyle=v.color; rrect(v.x,v.y,v.w,v.h,10);
    // highlight
    ctx.fillStyle="rgba(255,255,255,.15)"; rrect(v.x+4,v.y+4,v.w-8,v.h*0.35,8);
    // windows
    ctx.fillStyle="rgba(255,255,255,.75)";
    rrect(v.x+v.w*0.12, v.y+v.h*0.2, v.w*0.36, v.h*0.28, 6);
    rrect(v.x+v.w*0.54, v.y+v.h*0.2, v.w*0.28, v.h*0.28, 6);
    // wheels
    ctx.fillStyle="#0e0e0e"; const r=Math.max(6,Math.floor(v.h*0.18));
    ctx.beginPath(); ctx.arc(v.x+v.w*0.2, v.y+v.h-4, r,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(v.x+v.w*0.8, v.y+v.h-4, r,0,Math.PI*2); ctx.fill();
    // lights
    const night=state.night;
    if(night>0.3){
      ctx.fillStyle="rgba(253,230,138,"+(0.4+night*0.6)+")";
      ctx.fillRect(v.x+2, v.y+v.h*0.25, 4, 8);
      ctx.fillRect(v.x+2, v.y+v.h*0.65, 4, 8);
    }
  }
  function drawPlayer(){
    const p=state.player;
    // body
    ctx.fillStyle="#d1d5db"; rrect(p.x, p.y+p.h*0.18, p.w, p.h*0.62, 10);
    // windscreen
    ctx.fillStyle="#94a3b8"; rrect(p.x+p.w*0.15, p.y+p.h*0.22, p.w*0.7, p.h*0.24, 8);
    // wheels
    ctx.fillStyle="#0f0f0f"; const rw=Math.max(6,Math.floor(p.h*0.18));
    ctx.beginPath(); ctx.arc(p.x+p.w*0.2, p.y+p.h-4, rw,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(p.x+p.w*0.8, p.y+p.h-4, rw,0,Math.PI*2); ctx.fill();
    // headlights (at night)
    if(state.night>0.35){
      const g=ctx.createRadialGradient(p.x+p.w*0.5,p.y,2,p.x+p.w*0.5,p.y-40,120);
      g.addColorStop(0,"rgba(253,230,138,.35)"); g.addColorStop(1,"rgba(253,230,138,0)");
      ctx.fillStyle=g; ctx.fillRect(p.x-80,p.y-140,p.w+160,140);
    }
  }
  function drawPickup(it){
    if(it.kind==="fuel"){ ctx.fillStyle="#16a34a"; rrect(it.x,it.y,it.w,it.h,8); ctx.fillStyle="#0b1220"; ctx.fillRect(it.x+it.w*0.4,it.y+it.h*0.2,it.w*0.2,it.h*0.6); }
    else{ ctx.fillStyle="#ef4444"; rrect(it.x,it.y,it.w,it.h,10); ctx.fillStyle="#fff"; ctx.fillText("‚ù§", it.x+it.w*0.28, it.y+it.h*0.72); }
  }

  // AABB
  function hit(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

  // Loop
  function loop(now){
    if(!state.running) return;
    const dt = Math.min(0.05, (now - state.t)/1000); state.t = now;

    // Update world speed
    const target = braking ? WORLD_BASE*0.6 : PLAYER_MAX;
    if(state.player.speed < target) state.player.speed = Math.min(target, state.player.speed + ACCEL*dt);
    else state.player.speed = Math.max(target, state.player.speed - BRAKE*dt*0.6);

    // Fuel & score
    state.fuel -= FUEL_DRAIN*dt*(0.7 + state.player.speed/PLAYER_MAX*0.6);
    if(state.fuel<=0){ crash(true); return; }
    updateFuel();
    state.score += (state.player.speed*dt) * (0.02 * state.multiplier);
    scoreEl.textContent = Math.floor(state.score).toLocaleString();

    // Increase difficulty over time
    state.spawn.gap = Math.max(0.6, 1.2 - (state.score/8000));
    state.night = (state.night + DAYNIGHT_SPEED*dt) % 1; // 0..1 cycle

    // Spawn traffic & pickups
    state.spawn.timer += dt;
    if(state.spawn.timer >= state.spawn.gap){ state.spawn.timer=0; spawnVehicle(); if(Math.random()<0.3) spawnPickup(); }

    // Move traffic/pickups
    for(let i=state.traffic.length-1;i>=0;i--){
      const v = state.traffic[i]; v.y += (state.player.speed + v.speed*0.15) * dt;
      if(v.y > cvs.height+60) state.traffic.splice(i,1);
    }
    for(let i=state.pickups.length-1;i>=0;i--){
      const it=state.pickups[i]; it.y += state.player.speed*dt; if(it.y>cvs.height+40) state.pickups.splice(i,1);
    }

    // Player lane interpolation
    const targetX = laneX(state.player.target)-state.player.w/2;
    state.player.x += (targetX - state.player.x) * Math.min(1, LANE_CHANGE_SPEED*dt);

    // Collisions
    const p=state.player;
    for(let i=state.traffic.length-1;i>=0;i--){
      const v=state.traffic[i];
      if(hit(p,v)){ crash(false); return; }
      // near-miss (front bumper distance)
      const d = v.y + v.h - p.y;
      if(v.lane===state.player.target && d>0 && d<NEAR_MISS_DIST){
        state.multiplier = Math.min(5, state.multiplier + 0.02);
        state.nearMissTimer = now + NEAR_MISS_TIME;
      }
    }
    if(now > state.nearMissTimer) state.multiplier = Math.max(1, state.multiplier - 0.01);

    // Pickup collisions
    for(let i=state.pickups.length-1;i>=0;i--){
      const it=state.pickups[i];
      if(hit(p,it)){
        if(it.kind==="fuel"){ state.fuel = Math.min(FUEL_MAX, state.fuel + 30); updateFuel(); toastMsg("‚õΩ +30"); }
        else if(it.kind==="heart" && state.lives < LIVES_MAX){ state.lives++; updateHearts(); toastMsg("‚ù§Ô∏è +1"); }
        state.pickups.splice(i,1);
      }
    }

    // Draw
    ctx.clearRect(0,0,cvs.width,cvs.height);
    drawScene(now);
    // order: far ‚Üí near
    state.traffic.forEach(v=>drawCar(v));
    state.pickups.forEach(it=>drawPickup(it));
    drawPlayer();

    requestAnimationFrame(loop);
  }

  function drawScene(t){
    const roadW=cvs.width*0.82, left=(cvs.width-roadW)/2, roadH=cvs.height;
    // shoulders
    ctx.fillStyle="#08351f"; ctx.fillRect(0,0,left,roadH); ctx.fillRect(left+roadW,0,left,roadH);
    // road
    ctx.fillStyle="#101522"; rrect(left,0,roadW,roadH,16);
    // lane dashes scroll
    const dash = 36, gap=24, offset = (t/6)%(dash+gap);
    ctx.strokeStyle="#9ca3af55"; ctx.lineWidth=2; ctx.setLineDash([dash,gap]); ctx.lineDashOffset=-offset;
    for(let i=1;i<LANES;i++){ const x = left + roadW/LANES * i; ctx.beginPath(); ctx.moveTo(x,12); ctx.lineTo(x,roadH-12); ctx.stroke(); }
    ctx.setLineDash([]);

    // day/night overlay
    if(state.night>0.15){
      const alpha = 0.25 + 0.45*Math.sin(state.night*Math.PI); // gentle cycle
      ctx.fillStyle=`rgba(0,0,0,${alpha.toFixed(3)})`; ctx.fillRect(0,0,cvs.width,cvs.height);
    }

    // billboard Saudagar (checkpoint feel)
    ctx.fillStyle="#6f2c10"; rrect(cvs.width*0.07, 8, cvs.width*0.86, 18, 6);
    ctx.fillStyle="#f59e0b"; rrect(cvs.width*0.3, 10, cvs.width*0.4, 14, 4);
    ctx.fillStyle="#1f2937"; ctx.font="bold 12px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText("Saudagar", cvs.width*0.5, 17);
  }

  function crash(outOfFuel){
    if(outOfFuel){ toastMsg("Habis minyak!"); }
    else { toastMsg("Langgar! -1 nyawa"); }
    state.lives--; updateHearts();
    if(state.lives<=0){
      state.running=false; state.gameOver=true;
      const best = Math.max(state.best, Math.floor(state.score));
      state.best = best; localStorage.setItem('rr_best', best);
      showOverlay(true);
      overlay.querySelector('h1').textContent = "üí• Game Over";
      overlay.querySelector('p').innerHTML = `Skor: <b>${Math.floor(state.score).toLocaleString()}</b> ¬∑ Rekod: <b>${best.toLocaleString()}</b><br/>Tekan <b>Mula</b> untuk cuba lagi.`;
    }else{
      // slow down + small invuln by brief freeze
      state.player.speed = WORLD_BASE*0.5;
    }
  }

  // Kickoff
  reset();
})();
</script>
</body>
</html>
